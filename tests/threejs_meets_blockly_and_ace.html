<html>
<head>

<style type="text/css" media="screen">
	body {
		background-color:lightgray;
	}
	h3 {
		font-family:arial;
	}
    #ace_editors { 
    	position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 650px;

    }
    #ace_javascript {
    	position: absolute;
    	left: 400px;
    	top: 0;
    }
    #buttons {
    	position: absolute;
    	left: 410;
    	top: 135;
    }

</style>

<xml id="toolbox" style="display: none">
	<category name="Conditionals">
	<block type="controls_if"></block>
	<block type="controls_if">
	  <mutation else="1"></mutation>
	</block>
	<block type="controls_if">
	  <mutation elseif="1" else="1"></mutation>
	</block>
	</category>
	<category name="Loops">
	<block type="controls_repeat_ext">
	  <value name="TIMES">
	    <block type="math_number">
	      <title name="NUM">10</title>
	    </block>
	  </value>
	</block>
	<block type="controls_whileUntil"></block>
	<block type="controls_for">
	  <title name="VAR">i</title>
	  <value name="FROM">
	    <block type="math_number">
	      <title name="NUM">1</title>
	    </block>
	  </value>
	  <value name="TO">
	    <block type="math_number">
	      <title name="NUM">10</title>
	    </block>
	  </value>
	  <value name="BY">
	    <block type="math_number">
	      <title name="NUM">1</title>
	    </block>
	  </value>
	</block>
	<block type="controls_forEach"></block>
	<block type="controls_flow_statements"></block>
	</category>

	<category name="Logic">
	  <block type="logic_compare"></block>
	  <block type="logic_operation"></block>
	  <block type="logic_negate"></block>
	  <block type="logic_boolean"></block>
	  <block type="logic_null"></block>
	  <block type="logic_ternary"></block>
	</category>
	<category name="Math">
	  <block type="math_number"></block>
	  <block type="math_arithmetic"></block>
	  <block type="math_single"></block>
	  <block type="math_trig"></block>
	  <block type="math_constant"></block>
	  <block type="math_number_property"></block>
	  <block type="math_change">
	    <value name="DELTA">
	      <block type="math_number">
	        <title name="NUM">1</title>
	      </block>
	    </value>
	  </block>
	  <block type="math_round"></block>
	  <block type="math_on_list"></block>
	  <block type="math_modulo"></block>
	  <block type="math_constrain">
	    <value name="LOW">
	      <block type="math_number">
	        <title name="NUM">1</title>
	      </block>
	    </value>
	    <value name="HIGH">
	      <block type="math_number">
	        <title name="NUM">100</title>
	      </block>
	    </value>
	  </block>
	  <block type="math_random_int">
	    <value name="FROM">
	      <block type="math_number">
	        <title name="NUM">1</title>
	      </block>
	    </value>
	    <value name="TO">
	      <block type="math_number">
	        <title name="NUM">100</title>
	      </block>
	    </value>
	  </block>
	  <block type="math_random_float"></block>
	</category>
	<category name="Lists">
	  <block type="lists_create_empty"></block>
	  <block type="lists_create_with"></block>
	  <block type="lists_repeat">
	    <value name="NUM">
	      <block type="math_number">
	        <title name="NUM">5</title>
	      </block>
	    </value>
	  </block>
	  <block type="lists_length"></block>
	  <block type="lists_isEmpty"></block>
	  <block type="lists_indexOf"></block>
	  <block type="lists_getIndex"></block>
	  <block type="lists_setIndex"></block>
	</category>
	<category name="Variables" custom="VARIABLE"></category>
	<category name="Functions" custom="PROCEDURE"></category>

    <category name="Colors">
      <block type="colour_picker"></block>
      <block type="colour_random"></block>
      <block type="colour_rgb"></block>
      <block type="colour_blend"></block>
    </category>
</xml>


<script src="blockly_compressed.js" type="text/javascript" charset="utf-8"></script>
<script src="blocks_compressed.js" type="text/javascript" charset="utf-8"></script>
<script src="python_compressed.js" type="text/javascript"></script>
<script src="javascript_compressed.js" type="text/javascript"></script>

<script type="text/javascript" src="msg/js/en.js"></script>

<script src="pythonjs.js"></script>

<script src="bindings/blockly.py"></script>
<script src="bindings/websocket.py"></script>

<script src="libs/three/three.min.js"></script>

<!-- load the font files -->
<script src="libs/fonts/gentilis_bold.typeface.js"></script>
<script src="libs/fonts/gentilis_regular.typeface.js"></script>
<script src="libs/fonts/optimer_bold.typeface.js"></script>
<script src="libs/fonts/optimer_regular.typeface.js"></script>
<script src="libs/fonts/helvetiker_bold.typeface.js"></script>
<script src="libs/fonts/helvetiker_regular.typeface.js"></script>
<script src="libs/fonts/droid_sans_regular.typeface.js"></script>
<script src="libs/fonts/droid_sans_bold.typeface.js"></script>
<script src="libs/fonts/droid_serif_regular.typeface.js"></script>
<script src="libs/fonts/droid_serif_bold.typeface.js"></script>

<script src="bindings/three.py"></script>

<script src="libs/ace/ace.js" type="text/javascript" charset="utf-8"></script>
<script src="bindings/ace.py"></script>

<script type="text/python">

from websocket import *

def on_open(): print 'websocket open...'
def on_close(): print 'websocket closed'

def on_json_message( ob ):
	code = None
	with javascript:
		if typeof(ob) == 'string':
			print 'got string from server', ob
		elif 'eval' in ob:
			print 'got eval from server', ob
			code = ob['eval']
	if code:
		eval( ob['eval'] )
		JsEditor.setValue( ob['eval'] )


def compile_request(src):
	with javascript: ob = {command:'compile', code:src}
	ws.send_json_message( ob )

def connect_websocket():
	global ws
	ws = websocket(
		'ws://localhost:8080/websocket',
		on_json_message = on_json_message,
		on_open = on_open,
		on_close = on_close
	)
	print 'websocket->', ws

def compile_python():
	src = PyEditor.getValue()
	compile_request( src )

_ANIMATE = True
def start_animation():
	global _ANIMATE
	_ANIMATE = True
	animate()

def stop_animation():
	global _ANIMATE
	_ANIMATE = False

</script>

</head>

<body onload="javascript:connect_websocket()">



<div id="blocklyDiv" style="height: 660px; width: 630px;"></div>


<div id="ace_editors">
	<div id="ace_python" style="height: 180px; width: 400px;"></div>
	<div id="ace_javascript" style="height: 150px; width: 300px;"></div>

	<p id="buttons">
	<button onclick="javascript:compile_python()">recompile</button>
	<button onclick="javascript:start_animation()">start</button>
	<button onclick="javascript:stop_animation()">stop</button>
	</p>

<div id="THREE_container">
</div>

</div>

<script type="text/python">
from blockly import *
from three import *
from ace import *


PyEditor = AceEditor( 'ace_python', mode='python' )
JsEditor = AceEditor( 'ace_javascript', mode='javascript' )
JsEditor.setFontSize(9)

Meshes = []

block = StatementBlock(color=10, stack_input=True, category='Dynamic')
@block.javascript_callback
def vector(x=0,y=0,z=0):
	with javascript:
		return [x,y,z]

block = StatementBlock(color=20, stack_input=True, category='Dynamic')
@block.javascript_callback
def get_color( color ):
	with javascript:
		return parseInt( color.substring(1), 16 )


## special callbacks called from blockly generator update ##
with javascript:
	def set_vector( mesh, vec, arr ):
		if arr:
			vec.x = arr[0]
			vec.y = arr[1]
			vec.z = arr[2]

	def translate_local( mesh, vec, arr ):
		mesh.translateX( arr[0] )
		mesh.translateY( arr[1] )
		mesh.translateZ( arr[2] )

	def set_color( mat, color, hex ):
		color.setHex( hex )

##########################################################

block = StatementBlock(color=200, category='Materials')
block.add_input_statement('color', callback=set_color )
@block.callback
def Flat():
	mat = MeshBasicMaterial()
	return mat

block = StatementBlock(color=210, category='Materials')
block.add_input_statement('color', callback=set_color )
block.add_input_statement('ambient', callback=set_color )
block.add_input_statement('emissive', callback=set_color )
@block.callback
def Lambert():
	mat = MeshLambertMaterial()
	return mat

block = StatementBlock(color=220, category='Materials')
block.add_input_statement('color', callback=set_color )
block.add_input_statement('ambient', callback=set_color )
block.add_input_statement('emissive', callback=set_color )
@block.callback
def Phong():
	mat = MeshPhongMaterial()
	return mat


block = StatementBlock(category='Geometry')
block.add_input_statement('position', callback=set_vector )
block.add_input_statement('rotation', callback=set_vector )
block.add_input_statement('scale',    callback=set_vector )
@block.callback
def Circle( radius=4, segments=8, start=0, end=1, material=null, child=null ):
	start = 3.141592653589793 * 2 * start
	end = 3.141592653589793 * 2 * end
	geo = CircleGeometry( radius, segments, start, end )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh

block = StatementBlock(category='Geometry')
block.add_input_statement('position', callback=set_vector )
block.add_input_statement('rotation', callback=set_vector )
block.add_input_statement('scale',    callback=set_vector )
@block.callback
def Cube( width=10, height=10, length=10, material=null, child=null ):
	geo = CubeGeometry( width, height, length )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh

block = StatementBlock(category='Geometry')
block.add_input_statement('position', callback=set_vector )
block.add_input_statement('rotation', callback=set_vector )
block.add_input_statement('scale',    callback=set_vector )
@block.callback
def Cylinder( radiusTop=2, radiusBottom=2, height=4, material=null, child=null ):
	geo = CylinderGeometry( radiusTop, radiusBottom, height )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh

block = StatementBlock(category='Geometry')
block.add_input_statement('position', callback=set_vector )
block.add_input_statement('rotation', callback=set_vector )
block.add_input_statement('scale',    callback=set_vector )
@block.callback
def Text3D( text, size=10, material=null, child=null ):
	geo = TextGeometry( text, size )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh

block = StatementBlock(category='Geometry')
block.add_input_statement('position', callback=set_vector )
block.add_input_statement('rotation', callback=set_vector )
block.add_input_statement('scale',    callback=set_vector )
@block.callback
def Icosahedron( radius=1.0, detail=1, material=null, child=null ):
	geo = IcosahedronGeometry( radius, detail )
	if not material: material = MeshLambertMaterial()
	mesh = Mesh( geo, material )
	Meshes.append( mesh )
	if child: mesh.add( child )
	return mesh


with javascript:
	def set_clear_color(ren, meth, color):
		print 'set-clear-color', ren, meth, color
		meth( color )

block = StatementBlock(color=90, stack_input=False, stack_output=True, category='Scene')
block.add_input_statement('setClearColor', callback=set_clear_color )
@block.callback
def initialize( antialias=None ):
	global ren, scn, cam

	div = document.getElementById( 'THREE_container' )
	if div.firstChild:
		div.removeChild( div.firstChild )

	width = 700; height = 500
	scn = Scene()
	cam = PerspectiveCamera( 45, width/height, 0.01, 10000)
	cam.position.z = 100
	cam.position.x = 5

	ren = WebGLRenderer( antialias=antialias )
	ren.setSize( width, height )
	ren.setClearColor( red=0.7, green=0.7, blue=0.7 )

	div.appendChild( ren.domElement )

	light = PointLight()
	light.position.set( 0, 100, 90 )
	scn.add( light )

	return ren

sblock2 = StatementBlock(color=60, stack_input=True, stack_output=True, category='Scene')
@sblock2.slot_callback
def add_to_scene( object ):
	scn.add( object )



sblock3 = StatementBlock(color=30, category='Scene')
@sblock3.callback
def animate():
	if _ANIMATE:
		requestAnimationFrame( animate )

	for m in Meshes:
		m.rotation.x = m.rotation.x + 0.02
		m.rotation.y = m.rotation.y + 0.01

	ren.render( scn, cam )



def blockly_update_callback():
	with javascript: code = Blockly.Python.workspaceToCode()
	PyEditor.setValue( code )


initialize_blockly( on_changed_callback=blockly_update_callback )

</script>

</body>
</html>